// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ================== NEXT-AUTH (PrismaAdapter iÃ§in zorunlu) ==================
 */
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expires])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/**
 * ================== KULLANICI / Ã‡OKLU MAÄžAZA (TENANT) ==================
 */
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name         String?
  email        String   @unique @db.VarChar(191)
  passwordHash String
  role         UserRole @default(STAFF)

  // NextAuth
  accounts Account[]
  sessions Session[]

  // Bu kullanÄ±cÄ±nÄ±n oluÅŸturduÄŸu sipariÅŸler
  orders Order[] @relation("OrderCreatedBy")

  // Bu kullanÄ±cÄ±nÄ±n oluÅŸturduÄŸu tenant'lar
  tenantsOwned Tenant[] @relation("TenantCreatedBy")

  // Ãœyelikleri
  memberships Membership[]

  @@index([email])
  @@index([role])
}

enum UserRole {
  SUPERADMIN
  ADMIN
  STAFF
}

/**
 * ================== BILLING ENUMS ==================
 */
enum Plan {
  FREE
  PRO
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
}

enum InvoiceStatus {
  open
  paid
  failed
  voided
  refunded
}

/**
 * ================== ABONELÄ°K / FATURA ==================
 */
model Subscription {
  id                 String              @id @default(cuid())
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  tenantId           String              @unique
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  plan               Plan                @default(FREE)
  status             SubscriptionStatus  @default(trialing)

  provider           String              @default("manual") // "stripe" | "iyzico" | "paytr" | ...
  providerCustomerId String?
  providerSubId      String?

  currentPeriodStart DateTime?           // trial/abonelik dÃ¶nem baÅŸlangÄ±cÄ±
  currentPeriodEnd   DateTime?           // bir sonraki fatura/kesim tarihi
  cancelAtPeriodEnd  Boolean             @default(false)

  seats              Int                 @default(1)         // fiyatlandÄ±rma birimi (Ã¼yelik sayÄ±sÄ±)
  seatLimit          Int?                                   // planÄ±n izin verdiÄŸi Ã¼st sÄ±nÄ±r

  trialEndsAt        DateTime?           // opsiyonel deneme
  graceUntil         DateTime?           // Ã¶deme gecikmesi iÃ§in sÃ¼re

  invoices           Invoice[]

  @@index([tenantId, status])
  @@index([currentPeriodEnd])
}

model Invoice {
  id                 String         @id @default(cuid())
  createdAt          DateTime       @default(now())

  tenantId           String
  tenant             Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptionId     String?
  subscription       Subscription?  @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  status             InvoiceStatus  @default(open)
  amount             Decimal        @db.Decimal(12, 2)
  currency           String         @default("TRY")

  provider           String         @default("manual")
  providerInvoiceId  String?
  raw                Json?

  paidAt             DateTime?
  dueAt              DateTime?

  @@index([tenantId, createdAt])
  @@index([status])
}

/**
 * ================== TENANT ==================
 */
model Tenant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  name      String

  createdById String
  createdBy   User   @relation("TenantCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  memberships   Membership[]
  customers     Customer[]
  categories    Category[]
  variants      Variant[]
  orders        Order[]
  subscriptions Subscription[]   // ðŸ‘ˆ karÅŸÄ± alan eklendi
  invoices      Invoice[]        // ðŸ‘ˆ karÅŸÄ± alan eklendi
  // Ä°stersen aÃ§: @@unique([name, createdById])

  @@index([createdById])
}

model Membership {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId   String
  tenantId String
  role     TenantRole @default(OWNER)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
}

enum TenantRole {
  OWNER
  ADMIN
  STAFF
}

/**
 * ================== MÃœÅžTERÄ° ==================
 */
model Customer {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name    String
  phone   String
  email   String? @db.VarChar(191)
  address String?
  note    String?

  orders Order[]

  @@unique([tenantId, phone]) // aynÄ± telefon aynÄ± tenant'ta tek
  @@index([tenantId])
  @@index([tenantId, name])
}

/**
 * ================== KATALOG ==================
 */
model Category {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name       String
  variants   Variant[]
  orderItems OrderItem[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Variant {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name       String
  unitPrice  Decimal     @default(0) @db.Decimal(12, 2)
  categoryId String
  category   Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@unique([categoryId, name]) // kategori iÃ§inde isim tekil
  @@index([tenantId])
  @@index([categoryId])
  @@index([name])
}

/**
 * ================== SÄ°PARÄ°Åž ==================
 */
model Order {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  note      String?

  // Toplamlar
  total    Decimal @default(0) @db.Decimal(12, 2) // kalemler+ekstralar
  discount Decimal @default(0) @db.Decimal(12, 2) // TL iskonto
  netTotal Decimal @default(0) @db.Decimal(12, 2) // total - discount

  // Snapshot mÃ¼ÅŸteri (fiÅŸ gibi)
  customerName  String @default("")
  customerPhone String @default("")

  status OrderStatus @default(pending)

  // Opsiyonel iliÅŸki: Customer
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Opsiyonel: sipariÅŸi oluÅŸturan kullanÄ±cÄ±
  createdById String?
  createdBy   User?   @relation("OrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  items  OrderItem[]
  extras OrderExtra[] // Ã¼cretli STOR/AKSESUAR kalemleri

  // Eski serbest metin alanlarÄ± (raporlara katÄ±lmaz)
  storLines      Json?
  accessoryLines Json?

  @@index([tenantId, createdAt])
  @@index([tenantId, status, createdAt])
  @@index([tenantId, customerId])
  @@index([tenantId, customerName])
  @@index([tenantId, customerPhone])
  @@index([tenantId, createdById])
}

enum OrderStatus {
  pending
  processing
  completed
  cancelled
}

/**
 * mÂ² * fileDensity * unitPrice
 */
model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  variantId String
  variant   Variant @relation(fields: [variantId], references: [id])

  qty         Int
  width       Int // cm
  height      Int // cm
  unitPrice   Decimal @default(0) @db.Decimal(12, 2)
  fileDensity Decimal @default(1) @db.Decimal(3, 1) // 1.0, 1.5, 2.0, ...

  subtotal Decimal @default(0) @db.Decimal(12, 2)
  note     String?

  @@index([orderId])
  @@index([categoryId])
  @@index([variantId])
}

/**
 * Adet * Birim Fiyat
 */
model OrderExtra {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  type      ExtraType // STOR | ACCESSORY
  text      String
  qty       Int       @default(1)
  unitPrice Decimal   @default(0) @db.Decimal(12, 2)
  subtotal  Decimal   @default(0) @db.Decimal(12, 2) // qty * unitPrice
  note      String?

  createdAt DateTime @default(now())

  @@index([orderId, type])
}

enum ExtraType {
  STOR
  ACCESSORY
}
